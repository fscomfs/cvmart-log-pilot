apiVersion: apps/v1
kind: DaemonSet
metadata:
  name:  cvmart-log
  labels:
    name: cvmart-log
    app: cvmart-log
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: cvmart-log
  template:
    metadata:
      labels:
        name: cvmart-log
        app: cvmart-log
    spec:
      serviceAccount: pod-reader-account
      containers:
      - image: 192.168.1.186:8099/evtrain/cvmart-log:v1
        imagePullPolicy: Always
        name: log-pilot
        securityContext:
          privileged: true
        args:
          - "-base=/host"
        resources:
          requests:
            cpu: "20m"
            memory: "200M"
        livenessProbe:
          exec:
            command: ["/bin/bash","-c","/pilot/healthz"]
          initialDelaySeconds: 5
          timeoutSeconds: 5
        readinessProbe:
           exec:
            command:  ["/bin/bash","-c","/pilot/healthz"]
           initialDelaySeconds: 5
           timeoutSeconds: 5
        env:
        - name: PILOT_TYPE
          value: filebeat
        - name: PILOT_LOG_PREFIX
          value: cvmart
        - name: JWT_SEC
          value: "cvmart_djdajdfadjfasdfdsa"
        # - name: KUBERNETES_SERVICE_HOST
        #   value: 192.168.1.131
        # - name: KUBERNETES_SERVICE_PORT
        #   value: "6443"
##        - name: KUBERNETES_TOKEN
 ##         value: eyJhbGciOiJSUzI1NiIsImtpZCI6Ii1EQkxmRVlFMnFBNm1xcHk3U2NhSm0xUGhaZnlsT2dZeFNIZUFRZzBLU0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi14bjh0cCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjYyOTQ0YmQwLTNhN2MtNDNlYy05MTYyLTc3ZGNjYTEwMDU3NyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.JCyjrKbVMVis28DIAjp1L9BwlqT3XXGrTHH_oUN_4Xu6gcOP2GOokg9S66CXZR7CSPTtTWbpRFHu3KyoISQFl5TxatDGrHvEjbMtcugwHBTW6yrfxJs_woN4QphlFq5wBzmwcpvC1MXuj3VTIRvabnivfL3wa2qw3iccP8eYSPpaySVKChu60WW_oYMrvVOL3PG01DlWY2PuVS6-uHliCal5_lY22VWKo8AROpoe8tWVa5YEeY45LEe9bsK-WXqY9OweN3PLOGELpjAeY5wc5GJCsACm9Jvv43CfuGopz7rKD005dlfojY4GvF9IVnEMSXFtv0ZtDRSMwPqECubsnQ
        - name: MINIO_URL
          value: "192.168.1.175:9000"
        - name: MINIO_USERNAME
          value: "admin"
        - name: MINIO_PASSWORD
          value: "admin123"
        - name: BUCKET
          value: "cvmart-log"
        ports:
        - containerPort:  888
          name:  log-pilot
        volumeMounts:
        - mountPath: /var/run/docker.sock
          name: docker-sock
        - mountPath: /host
          name: docker-log
          readOnly: true
        - mountPath: /out
          name: filebeat-out
        - mountPath: /config
          name: filebeat-config
        - mountPath: /etc/localtime
          name: localtime
          readOnly: true
      volumes:
        - name: docker-sock
          hostPath: 
            path: /var/run/docker.sock
        - name: docker-log
          hostPath: 
            path: /
        - name: filebeat-out
          hostPath: 
            path: /log-minitor/out
        - name: filebeat-config
          hostPath: 
            path: /log-minitor/config 
        - name: localtime
          hostPath:
             path: /etc/localtime
      restartPolicy: Always
      imagePullSecrets:
        - name: "eagle-nest-registry-key"
      # nodeSelector:
      #   kubernetes.io/arch: amd64
---
kind: Service
apiVersion: v1
metadata:
  name: cvmart-log-service
  namespace: kube-system
spec:
  selector:
    app: cvmart-log
  type: NodePort
  ports:
  - name: log-pilot
    port: 5465
    targetPort: 5465
    nodePort: 5465
---
kind: Service
apiVersion: v1
metadata:
  name: cvmart-proxy-service
  namespace: kube-system
spec:
  selector:
    app: cvmart-log
  type: NodePort
  ports:
  - name: log-pilot
    port: 5466
    targetPort: 5466
    nodePort: 5466


---
apiVersion: v1
kind: ServiceAccount
metadata:
  name:  pod-reader-account
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-reader-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-reader-global
subjects:
- kind: ServiceAccount
  name: pod-reader-account
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: pod-reader-role
  apiGroup: rbac.authorization.k8s.io
